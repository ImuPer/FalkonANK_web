{% extends 'base.html.twig' %}

{% block title %}{{ 'orders.accounting_title'|trans }}{% endblock %}

{% block stylesheets %}
	<link rel="stylesheet" href="{{ asset('css/style.css') }}">
{% endblock %}

{% block body %}
<div class="container mt-4">

	{% set orderGroups = {
		'orders.finished_week': ordersWk,
		'orders.finished': orders,
		'orders.refunded': ordersR,
		'orders.refund_in_progress': ordersCR,
		'orders.not_finished': ordersN
	} %}

	{% for sectionKey, ordersList in orderGroups %}
		{% set groupedOrders = {} %}

		{% for order in ordersList %}
			{% set groupKey = sectionKey == 'orders.finished_week' ? order.year_week : order.month %}
			{% set groupedOrders = groupedOrders|merge({
				(groupKey): (groupedOrders[groupKey] ?? [])|merge([order])
			}) %}
		{% endfor %}

		<div class="text-center mt-5 mb-3">
			<h3 style="
				color:
				{{ sectionKey == 'orders.finished' ? 'green'
				: sectionKey == 'orders.refunded' ? 'black'
				: sectionKey == 'orders.refund_in_progress' ? 'orange'
				: sectionKey == 'orders.finished_week' ? '#007bff'
				: 'red' }};
			">
				{{ sectionKey|trans }}
			</h3>
		</div>

		{% if groupedOrders is empty %}
			<div class="alert alert-info text-center">
				{{ 'orders.none_for_section'|trans({'%section%': sectionKey|trans|lower}) }}
			</div>
		{% else %}
			{% for month, orders in groupedOrders %}
				<div class="month-section mb-4">
					<div class="month-header">
						ðŸ“…
						{% if sectionKey == 'orders.finished_week' %}
							{{ 'orders.week'|trans }} : {{ month }}
						{% else %}
							{{ month|date("F \\d\\e Y") }}
						{% endif %}
					</div>

					<div class="table-responsive">
						<table class="table table-bordered table-hover table-sm">
							<thead>
								<tr>
									<th>{{ 'orders.ref'|trans }}</th>
									<th>{{ 'orders.date'|trans }}</th>
									<th>{{ 'orders.status'|trans }}</th>
									<th>{{ 'orders.total'|trans }}</th>
									{% if isAdmin %}
										<th>{{ 'orders.final'|trans }}</th>
									{% endif %}
									<th>{{ 'orders.refund'|trans }}</th>
									{% if isAdmin %}
										<th>{{ 'orders.stripe'|trans }}</th>
									{% endif %}
									<th>{{ 'orders.shop_email'|trans }}</th>
								</tr>
							</thead>
							<tbody>
								{% for order in orders %}
									{% set statusColor =
										order.order_status == 'Entregue e finalizado' ? '#28a745' :
										order.order_status == 'Em processamento' ? '#dc3545' :
										order.order_status == 'Em curso' ? '#ce8404' :
										order.order_status == 'Reembolso' ? '#ce8404' :
										'#999'
									%}

									<tr>
										<td>{{ order.order_ref }}</td>
										<td>{{ order.order_date|date('d/m/Y H:i') }}</td>
										<td>
											<span class="badge" style="background-color: {{ statusColor }}; color: white;">
												{{ order.order_status|trans }}
											</span>
										</td>
										<td>{{ (order.total_amount / 100)|number_format(0, ',', ' ') }} escudos</td>
										{% if isAdmin %}
											<td>{{ (order.amount_final / 100)|number_format(0, ',', ' ') }} escudos</td>
										{% endif %}
										<td>{{ ((order.refund_amount ?? 0) / 100)|number_format(0, ',', ' ') }} escudos</td>
										{% if isAdmin %}
											<td>{{ order.stripe_pay_id }}</td>
										{% endif %}
										<td>{{ order.customer_email }}</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				</div>
			{% endfor %}
		{% endif %}
	{% endfor %}
</div>
{% endblock %}
