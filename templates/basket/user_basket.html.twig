{% extends 'base.html.twig' %}

{% block title %}
	{{ 'basket.title'|trans }}
{% endblock %}

{% block body %}
	<link rel="stylesheet" href="{{ asset('css/basket.css') }}">

	<div class="basket-container">
		<h2 class="text-center">{{ 'basket.heading'|trans }}</h2>
		{% set totalPrice = 0 %}

		{% if basketPs is empty %}
			<p>{{ message|trans }}</p>
			<div class="d-inline-flex p-3">
				<a href="{{ path('app_home_page') }}">
					<button type="button" class="btn btn-dark">{{ 'basket.back_to_shop'|trans }}</button>
				</a>
			</div>
		{% else %}
			{% for basketP in basketPs %}
				<div class="basket-item" data-id="{{ basketP.getId() }}">
					<div class="item-image">
						<a href="{{ path('app_product_show', {'id': basketP.getProduct().getId()}) }}">
							<img src="{{ asset('upload/images/products/' ~ basketP.getProduct().getImg()) }}" alt="">
						</a>
					</div>
					<div class="item-info">
						<h2 class="item-name">{{ basketP.getProduct().getName() }}</h2>
						<p class="item-price">{{ (basketP.getProduct().getFinalPrice()/100) | number_format(2, ',', '.') }}
							CVE</p>
						<p class="small">
							<span class="text-danger">{{ 'basket.city'|trans }}:
								{{ basketP.getProduct().getShop().getCity().getName() }}</span>
						</p>
					</div>
					<div class="item-controls">
						<button class="quantity-btn" onclick="updateQuantity('{{ basketP.getId() }}', {{ basketP.quantity }} - 1)">&#8722;</button>
						<span class="item-quantity">{{ basketP.quantity }}</span>
						<button class="quantity-btn" onclick="updateQuantity('{{ basketP.getId() }}', {{ basketP.quantity }} + 1)">&#43;</button>

						{{ include('basket/_delete_form.html.twig') }}
					</div>
				</div>
				{% set productPrice = basketP.getProduct().getFinalPrice()|default(0) %}
				{% set quantity = basketP.quantity|default(1) %}
				{% set totalPrice = totalPrice + (productPrice * quantity) %}
			{% else %}
				<p class="empty-basket">{{ 'basket.empty'|trans }}</p>
				<div class="d-inline-flex p-3">
					<a href="{{ path('app_home_page') }}">
						<button type="button" class="btn btn-dark">{{ 'basket.back_to_shop'|trans }}</button>
					</a>
				</div>
			{% endfor %}
		{% endif %}

		{% if basketPs|length > 0 %}
			<div class="basket-total">
				<h3>{{ 'basket.total'|trans }}:
					{{ (totalPrice/100) | number_format(2, ',', '.') }}
					CVE</h3>

				{% set conversionRate = 110 %}
				{% set conversionRateDolar = 100 %}

				<p>{{ ((totalPrice/100) / conversionRate)|number_format(2, ',', '.') }}
					€ ({{ 'currency.euro'|trans }})</p>
				<p>{{ ((totalPrice/100) / conversionRateDolar)|number_format(2, ',', '.') }}
					$ ({{ 'currency.usd'|trans }})</p>
			</div>

			<form action="{{ path('app_checkout') }}" method="post" class="mt-3">
				<input type="hidden" name="total" value="{{ totalPrice }}"/>
				<button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#checkoutModal">
					{{ 'basket.checkout'|trans }}
				</button>

				<div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
					<div class="modal-dialog">
						<div class="modal-content">
							<form method="post" action="{{ path('app_checkout') }}">
								<div class="modal-header">
									<h5 class="modal-title" id="checkoutModalLabel">{{ 'checkout.modal_title'|trans }}</h5>
									<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ 'checkout.close'|trans }}"></button>
								</div>
								<div class="modal-body">
									<div class="mb-3">
										<label for="city" class="form-label">{{ 'checkout.city'|trans }}
											*</label>
										<select class="form-select" id="city" name="city_id" required>
											<option value="">{{ 'checkout.select_city'|trans }}</option>
											{% for city in cities %}
												<option value="{{ city.id }}">{{ city.name }}</option>
											{% endfor %}
										</select>
									</div>
									<div id="delivery-warning" class="text-danger mt-2 d-none">
										{{ 'checkout.select_city_first'|trans }}
									</div>
									<div class="mb-3">
										<label for="beneficiary_name" class="form-label">{{ 'checkout.name'|trans }}
											*</label>
										<input type="text" class="form-control" name="beneficiary_name" required>
									</div>
									<div class="mb-3">
										<label for="beneficiary_address" class="form-label">{{ 'checkout.address'|trans }}
											*</label>
										<input type="text" class="form-control" name="beneficiary_address" required>
									</div>
									<div class="mb-3">
										<label for="beneficiary_email" class="form-label">{{ 'checkout.email'|trans }}</label>
										<input type="text" class="form-control" name="beneficiary_email">
									</div>
									<div class="mb-3">
										<label for="phone" class="form-label">{{ 'checkout.phone'|trans }}</label>
										<input type="tel" class="form-control" name="phone" required>
									</div>
									<input type="hidden" name="total" value="{{ totalPrice }}"/>
									{# <br> #}
									{# delivery---------------------------------------------------------------------------------------------------- #}
									{# <hr> #}
                                    <h5>{{ 'delivery.title'|trans }} :</h5>
										<div class="mb-3"> <label class="form-label">
											{{ 'checkout.delivery_method'|trans }}
										</label>

										<div class="form-check">
											<input class="form-check-input delivery-radio" type="radio" name="delivery_method" value="standard">
											<label class="form-check-label">
												{{ 'delivery.standard'|trans }}
											</label>
										</div>

										<div class="form-check">
											<input class="form-check-input delivery-radio" type="radio" name="delivery_method" value="express">
											<label class="form-check-label">
												{{ 'delivery.express'|trans }}
											</label>
										</div>
									</div>

									<div class="mb-3">
										<strong>
											{{ 'checkout.delivery_price'|trans }}:
										</strong>
										<span id="delivery-price">--</span>
										CVE
									</div>

									<input
									type="hidden" name="delivery_price" id="delivery_price_input">
								{# fin delivery-------------------------------------------------------------------------------------------- #}
								</div>
								<div class="modal-footer">
									<button type="submit" class="btn btn-success">{{ 'checkout.confirm'|trans }}</button>
								</div>
							</form>
						</div>
					</div>
				</div>
			</form>

			<div class="d-inline-flex p-3">
				<a href="{{ path('app_home_page') }}">
					<button type="button" class="btn btn-dark">{{ 'basket.back_to_shop'|trans }}</button>
				</a>
			</div>
		{% endif %}
	</div>

	<script>
		function updateQuantity(productId, newQuantity) {
if (newQuantity < 0) 
return;



let url;
if (newQuantity === 0) {
url = "{{ path('app_removePB_delite', {'id': 'PLACEHOLDER_ID'}) }}".replace('PLACEHOLDER_ID', productId);
} else {
url = "{{ path('app_quantity_edit', {'id': 'PLACEHOLDER_ID', 'quantity': 'PLACEHOLDER_QUANTITY'}) }}".replace('PLACEHOLDER_ID', productId).replace('PLACEHOLDER_QUANTITY', newQuantity);
}

const csrfToken = '{{ csrf_token('update_quantity') }}';

fetch(url, {
method: 'POST',
headers: {
'X-Requested-With': 'XMLHttpRequest',
'Content-Type': 'application/json',
'X-CSRF-TOKEN': csrfToken
}
}).then(response => {
if (!response.ok) 
throw new Error (`HTTP error! status: ${
response.status
}`);



return response.json();
}).then(data => {
if (data.success) {
if (newQuantity === 0) {
document.querySelector (`.basket-item[data-id="${productId}"]`).remove();
} else {
window.location.reload();
}
} else {
console.error('Erreur lors de la mise à jour du panier:', data.message);
}
}).catch(error => console.error('Erreur lors de la requête:', error));
}
	</script>

	{# Delivery Script------------------- #}
	<script>
document.querySelectorAll('.delivery-radio').forEach(radio => {
    radio.addEventListener('change', function () {
        const citySelect = document.getElementById('city');
        const warning = document.getElementById('delivery-warning');

        if (!citySelect.value) {
            // ❌ pas de ville sélectionnée
            this.checked = false;

            if (warning) {
                warning.classList.remove('d-none');
            }

            citySelect.focus();
            return;
        }

        if (warning) {
            warning.classList.add('d-none');
        }

        calculateDelivery();
    });
});

document.getElementById('city').addEventListener('change', function () {
    const warning = document.getElementById('delivery-warning');
    if (warning) {
        warning.classList.add('d-none');
    }

    const checkedMethod = document.querySelector('input[name="delivery_method"]:checked');
    if (checkedMethod) {
        calculateDelivery();
    }
});

function calculateDelivery() {
    const cityId = document.getElementById('city').value;
    const method = document.querySelector('input[name="delivery_method"]:checked');

    if (!cityId || !method) return;

    fetch("{{ path('app_delivery_calculate') }}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            city_id: cityId,
            method: method.value
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            document.getElementById('delivery-price').innerText = data.price;
            document.getElementById('delivery_price_input').value = data.price;
        }
    })
    .catch(err => console.error(err));
}
</script>


{% endblock %}
